
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/amorphous_characterization/FEM.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_amorphous_characterization_FEM.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_amorphous_characterization_FEM.py:


Fluctuation Electron Microscopy
===============================
This example shows you how to perform a fluctuation electron microscopy (FEM) analysis.

In this example we will focus on calculating :math:`V_\Omega (k)` which is defined as,

Equation 1:

.. math::

    V_\Omega (k) = \frac{\langle I{^2}(k) \rangle{_r} - \langle I(k)\rangle_r^2}{\langle I(k)\rangle_r^2 } - \frac{G}{\langle I(k)\rangle_r}

where :math:`I(k)` is the diffracted electron intensity averaged over the polar angle at constant scattering
vector magnitude k, :math:`<>_r` indicates averaging over probe positions, and G is the gain of the electron camera
in counts per electron for counted or data from hybrid pixel detectors this value is 1 otherwise it will be some
mean value. The first term is the definition of the variance, and the second term is a correction to
the variance for Poisson noise in the data.

(There are several different possible variance signals. Here, we use the notation from
Daulton, et al. Ultramicroscopy 110, 1279–1289 (2010), DOI: 10.1016/j.ultramic.2010.05.010.)

.. GENERATED FROM PYTHON SOURCE LINES 23-33

.. code-block:: Python


    import pyxem as pxm
    from pyxem.utils import determine_ellipse
    import numpy as np
    import hyperspy.api as hs
    from pyxem.utils._pixelated_stem_tools import _copy_axes_object_metadata

    s = pxm.data.zrcual_1(allow_download=True, signal_type="electron_diffraction")
    s.plot()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_001.png
         :alt: pos1-1 Navigator
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_001.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_002.png
         :alt: pos1-1 Signal
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_002.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/hyperspy/misc/utils.py:72: VisibleDeprecationWarning: `_get_block_pattern` has moved to `hyperspy.misc.dask_utils`. It is for internal use only and may be removed in the future.
      warnings.warn(
    Downloading file 'pos1-1.zspy' from 'https://zenodo.org/records/15490547/files/pos1-1.zspy' to '/home/runner/.cache/pyxem/0.21.0'.
      0%|                                              | 0.00/18.3M [00:00<?, ?B/s]      0%|                                     | 14.3k/18.3M [00:00<03:58, 76.4kB/s]      0%|                                     | 37.9k/18.3M [00:00<03:17, 92.3kB/s]      1%|▏                                      | 109k/18.3M [00:00<01:20, 224kB/s]      1%|▌                                      | 246k/18.3M [00:00<00:40, 442kB/s]      3%|█                                      | 524k/18.3M [00:00<00:20, 857kB/s]      6%|██▏                                  | 1.06M/18.3M [00:01<00:10, 1.64MB/s]     12%|████▍                                | 2.16M/18.3M [00:01<00:05, 3.22MB/s]     20%|███████▍                             | 3.69M/18.3M [00:01<00:02, 5.78MB/s]     24%|████████▉                            | 4.39M/18.3M [00:01<00:04, 3.19MB/s]     27%|█████████▉                           | 4.91M/18.3M [00:02<00:05, 2.50MB/s]     29%|██████████▊                          | 5.32M/18.3M [00:02<00:06, 1.93MB/s]     31%|███████████▍                         | 5.64M/18.3M [00:02<00:07, 1.72MB/s]     32%|███████████▉                         | 5.89M/18.3M [00:03<00:07, 1.62MB/s]     33%|████████████▎                        | 6.11M/18.3M [00:03<00:07, 1.63MB/s]     35%|████████████▊                        | 6.31M/18.3M [00:03<00:07, 1.61MB/s]     36%|█████████████▏                       | 6.49M/18.3M [00:03<00:07, 1.64MB/s]     37%|█████████████▌                       | 6.68M/18.3M [00:03<00:07, 1.55MB/s]     37%|█████████████▊                       | 6.84M/18.3M [00:03<00:08, 1.41MB/s]     38%|██████████████▏                      | 6.99M/18.3M [00:03<00:08, 1.26MB/s]     39%|██████████████▍                      | 7.13M/18.3M [00:04<00:08, 1.25MB/s]     40%|██████████████▊                      | 7.34M/18.3M [00:04<00:07, 1.45MB/s]     41%|███████████████▎                     | 7.58M/18.3M [00:04<00:06, 1.68MB/s]     43%|███████████████▊                     | 7.79M/18.3M [00:04<00:05, 1.77MB/s]     44%|████████████████▏                    | 7.97M/18.3M [00:04<00:05, 1.72MB/s]     45%|████████████████▌                    | 8.15M/18.3M [00:04<00:06, 1.54MB/s]     46%|████████████████▊                    | 8.32M/18.3M [00:04<00:06, 1.56MB/s]     46%|█████████████████▏                   | 8.48M/18.3M [00:04<00:06, 1.51MB/s]     47%|█████████████████▍                   | 8.64M/18.3M [00:04<00:07, 1.28MB/s]     48%|█████████████████▊                   | 8.77M/18.3M [00:05<00:07, 1.23MB/s]     49%|██████████████████                   | 8.90M/18.3M [00:05<00:07, 1.17MB/s]     50%|██████████████████▎                  | 9.05M/18.3M [00:05<00:07, 1.24MB/s]     51%|██████████████████▊                  | 9.26M/18.3M [00:05<00:06, 1.46MB/s]     52%|███████████████████                  | 9.41M/18.3M [00:05<00:06, 1.33MB/s]     52%|███████████████████▎                 | 9.55M/18.3M [00:05<00:06, 1.29MB/s]     53%|███████████████████▌                 | 9.68M/18.3M [00:05<00:06, 1.29MB/s]     54%|███████████████████▉                 | 9.82M/18.3M [00:05<00:06, 1.28MB/s]     54%|████████████████████▏                | 9.95M/18.3M [00:06<00:06, 1.26MB/s]     55%|████████████████████▍                | 10.1M/18.3M [00:06<00:06, 1.27MB/s]     56%|████████████████████▋                | 10.2M/18.3M [00:06<00:06, 1.28MB/s]     57%|████████████████████▉                | 10.3M/18.3M [00:06<00:06, 1.24MB/s]     57%|█████████████████████▎               | 10.5M/18.3M [00:06<00:05, 1.31MB/s]     58%|█████████████████████▌               | 10.7M/18.3M [00:06<00:05, 1.41MB/s]     59%|█████████████████████▉               | 10.8M/18.3M [00:06<00:05, 1.46MB/s]     60%|██████████████████████▏              | 11.0M/18.3M [00:06<00:05, 1.43MB/s]     61%|██████████████████████▌              | 11.2M/18.3M [00:06<00:04, 1.53MB/s]     62%|██████████████████████▉              | 11.3M/18.3M [00:06<00:04, 1.52MB/s]     63%|███████████████████████▎             | 11.5M/18.3M [00:07<00:04, 1.65MB/s]     64%|███████████████████████▋             | 11.7M/18.3M [00:07<00:03, 1.68MB/s]     65%|████████████████████████             | 11.9M/18.3M [00:07<00:03, 1.65MB/s]     66%|████████████████████████▎            | 12.0M/18.3M [00:07<00:04, 1.55MB/s]     67%|████████████████████████▋            | 12.2M/18.3M [00:07<00:03, 1.56MB/s]     68%|█████████████████████████            | 12.3M/18.3M [00:07<00:03, 1.49MB/s]     68%|█████████████████████████▎           | 12.5M/18.3M [00:07<00:04, 1.40MB/s]     69%|█████████████████████████▌           | 12.6M/18.3M [00:07<00:04, 1.31MB/s]     70%|█████████████████████████▊           | 12.8M/18.3M [00:08<00:04, 1.13MB/s]     71%|██████████████████████████           | 12.9M/18.3M [00:08<00:05, 1.07MB/s]     71%|███████████████████████████           | 13.0M/18.3M [00:08<00:05, 982kB/s]     72%|███████████████████████████▎          | 13.1M/18.3M [00:08<00:05, 936kB/s]     72%|███████████████████████████▍          | 13.2M/18.3M [00:08<00:05, 956kB/s]     73%|███████████████████████████          | 13.4M/18.3M [00:08<00:04, 1.09MB/s]     74%|███████████████████████████▍         | 13.6M/18.3M [00:08<00:03, 1.35MB/s]     75%|███████████████████████████▊         | 13.7M/18.3M [00:08<00:03, 1.34MB/s]     76%|████████████████████████████         | 13.8M/18.3M [00:08<00:03, 1.32MB/s]     77%|████████████████████████████▎        | 14.0M/18.3M [00:09<00:03, 1.33MB/s]     77%|████████████████████████████▌        | 14.1M/18.3M [00:09<00:03, 1.34MB/s]     78%|████████████████████████████▉        | 14.3M/18.3M [00:09<00:02, 1.37MB/s]     79%|█████████████████████████████▎       | 14.4M/18.3M [00:09<00:02, 1.50MB/s]     81%|█████████████████████████████▊       | 14.7M/18.3M [00:09<00:01, 1.78MB/s]     82%|██████████████████████████████▎      | 15.0M/18.3M [00:09<00:01, 1.97MB/s]     83%|██████████████████████████████▋      | 15.2M/18.3M [00:09<00:01, 1.79MB/s]     84%|███████████████████████████████      | 15.4M/18.3M [00:09<00:01, 1.79MB/s]     85%|███████████████████████████████▍     | 15.5M/18.3M [00:09<00:01, 1.79MB/s]     86%|███████████████████████████████▊     | 15.7M/18.3M [00:10<00:01, 1.62MB/s]     87%|████████████████████████████████▏    | 15.9M/18.3M [00:10<00:01, 1.48MB/s]     88%|████████████████████████████████▍    | 16.0M/18.3M [00:10<00:01, 1.48MB/s]     89%|████████████████████████████████▊    | 16.2M/18.3M [00:10<00:01, 1.30MB/s]     89%|█████████████████████████████████    | 16.3M/18.3M [00:10<00:01, 1.25MB/s]     90%|█████████████████████████████████▎   | 16.5M/18.3M [00:10<00:01, 1.27MB/s]     91%|█████████████████████████████████▋   | 16.6M/18.3M [00:10<00:01, 1.31MB/s]     92%|█████████████████████████████████▉   | 16.7M/18.3M [00:10<00:01, 1.19MB/s]     92%|██████████████████████████████████▏  | 16.9M/18.3M [00:11<00:01, 1.17MB/s]     93%|██████████████████████████████████▌  | 17.1M/18.3M [00:11<00:00, 1.35MB/s]     95%|██████████████████████████████████▉  | 17.3M/18.3M [00:11<00:00, 1.55MB/s]     95%|███████████████████████████████████▎ | 17.4M/18.3M [00:11<00:00, 1.57MB/s]     96%|███████████████████████████████████▋ | 17.6M/18.3M [00:11<00:00, 1.54MB/s]     97%|███████████████████████████████████▉ | 17.8M/18.3M [00:11<00:00, 1.54MB/s]     98%|████████████████████████████████████▎| 17.9M/18.3M [00:11<00:00, 1.56MB/s]     99%|████████████████████████████████████▋| 18.1M/18.3M [00:11<00:00, 1.66MB/s]      0%|                                              | 0.00/18.3M [00:00<?, ?B/s]    100%|█████████████████████████████████████| 18.3M/18.3M [00:00<00:00, 99.1GB/s]




.. GENERATED FROM PYTHON SOURCE LINES 34-38

Using Manual Ellipse Determination
----------------------------------
Sometimes it is useful to force the ellipse to fit certain points.  For example, here we
can force the ellipse to fit the first ring by masking the zero beam.

.. GENERATED FROM PYTHON SOURCE LINES 38-59

.. code-block:: Python


    summed = s.sum()

    center, affine, params, pos = pxm.utils.ransac_ellipse_tools.determine_ellipse(
        summed,
        return_params=True,
        num_points=500,
        use_ransac=False,
    )
    el, in_points = pxm.utils.ransac_ellipse_tools.ellipse_to_markers(
        ellipse_array=params,
        points=pos,
    )

    # we don't account for scales/offsets yet
    summed.axes_manager.signal_axes[0].scale = 1
    summed.axes_manager.signal_axes[1].scale = 1
    summed.axes_manager.signal_axes[1].offset = 0
    summed.axes_manager.signal_axes[0].offset = 0






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:677: FutureWarning: Calling ``EllipseModel()`` (without arguments) has been deprecated since version 0.26 and will be removed in version 2.2; see help for ``EllipseModel``.
      e = EllipseModel()
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:678: FutureWarning: `estimate` is deprecated since version 0.26 and will be removed in version 2.2. Please use `EllipseModel.from_estimate` class constructor instead.
      converge = e.estimate(data=pos)
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:681: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      affine = _ellipse_to_affine(el.params[3], el.params[2], el.params[4])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:682: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      center = (el.params[0], el.params[1])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:686: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      return center, affine, el.params, pos




.. GENERATED FROM PYTHON SOURCE LINES 60-65

Checking
--------
Let's check to make sure that things are behaving.  We can first plot the ellipse over
the data and then take the azimuthal integral/sum.
That should end up a nice straight line

.. GENERATED FROM PYTHON SOURCE LINES 65-77

.. code-block:: Python


    summed.plot()
    summed.add_marker(in_points, plot_marker=True)
    summed.add_marker(el, plot_marker=True)


    s.calibration.center = center[::-1]  # reverse the center.
    s.calibration.affine = affine
    az = s.get_azimuthal_integral2d(npt=100).sum().isig[:, 2.0:8.0]

    az.sum().plot()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_003.png
         :alt:  Signal
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_003.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_004.png
         :alt:  Signal
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_004.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/26 [00:00<?, ?it/s]      4%|▍         | 1/26 [00:03<01:20,  3.20s/it]     65%|██████▌   | 17/26 [00:03<00:01,  7.09it/s]    100%|██████████| 26/26 [00:03<00:00,  7.74it/s]




.. GENERATED FROM PYTHON SOURCE LINES 78-86

Getting the Variance
--------------------
The :meth:`~.signals.diffraction2d.get_variance` function will calculate the variance using the affine correction
and the center as described above. Restricting the radial range is also nice to remove
the effects of the high intensity at the top end. Adding a mask can also be helpful for
reducing the effects of a beam stop. The ``gain`` parameter is number of detector units for 1 electron.
It's used for the Poisson noise correction. If the data are already calibrated in units of electron counts,
use a gain of 1.

.. GENERATED FROM PYTHON SOURCE LINES 86-93

.. code-block:: Python


    mask = summed < 10000
    mask.plot()
    variance = s.get_variance(npt=50, gain=4.2, radial_range=(3.0, 5.75), mask=mask)
    variance.axes_manager[0].units = "$nm^{-1}$"
    variance.plot()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_005.png
         :alt:  Signal
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_006.png
         :alt:  Signal
         :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_006.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/51 [00:00<?, ?it/s]      2%|▏         | 1/51 [00:00<00:44,  1.11it/s]     86%|████████▋ | 44/51 [00:00<00:00, 59.89it/s]    100%|██████████| 51/51 [00:01<00:00, 50.79it/s]
      0%|          | 0/51 [00:00<?, ?it/s]      2%|▏         | 1/51 [00:00<00:35,  1.42it/s]    100%|██████████| 51/51 [00:00<00:00, 66.10it/s]




.. GENERATED FROM PYTHON SOURCE LINES 94-104

Getting a (Good) Variance
-------------------------
If the TEM sample varies in thickness by more than a few nm over the entire dataset,
thickness-related differences in the diffracted intensity  will dominate structure-related
differences and therefore dominate. This effect can be avoided by using the HAADF signal or
the high-angle scattering within the diffraction pattern to determine the local sample thickness,
grouping the diffraction patterns into bins of nearly constant thickness, and only computing :math:`V_\\Omega (k)`
for data inside a single bin. The :math:`V_\\Omega (k)` from different thickness bins then can be averaged
together. See Hwang and Voyles Microscopy and Microanalysis 17, 67–74 (2011), DOI: 10.1017/S1431927610094109
and Li et al. Microscopy and Microanalysis 20, 1605–1618 (2014). DOI: 10.1017/s1431927614012756 for more details.

.. GENERATED FROM PYTHON SOURCE LINES 104-108

.. code-block:: Python


    # We have already saved the simultaneously-acquired HAADF image along side the dataset. We can see this here...
    haadf = s.metadata.HAADF.intensity








.. GENERATED FROM PYTHON SOURCE LINES 109-121

The HAADF signal for an amorphous material is linear in the thickness for typical TEM sample thicknesses.
To convert the HAADF digital counts to thickness (in e.g. nm), the slope and intercept of the linear
relationship must be known. The intercept is the black level of the HAADF detector in digital counts,
which in this case is 26,265. The slope must be calibrated for each experiment from a measurement of
the HAADF intensity at a position of known sample thickness. In this case, the slope is 440.46 digital
counts / nm of sample thickness.

TEM sample thickness for amorphous materials can be measured independently either using electron energy
loss spectroscopy (EELS), in which the inelastic mean free path of the material must be known, or using total
elastic scattering, in which case the elastic mean free path of the material must be known. A reasonable model
for the elastic mean free path for many inorganic materials may be found
in Zhang et al. Ultramicroscopy 171, 89–95 (2016), DOI: 10.1016/j.ultramic.2016.09.005.

.. GENERATED FROM PYTHON SOURCE LINES 121-156

.. code-block:: Python


    thickness = (haadf - 26265) / 440.46


    def thickness_filter(signal, thickness, bins):
        masks = [
            np.logical_and(bins[i] < thickness, bins[i + 1] > thickness)
            for i in range(len(bins) - 1)
        ]
        filtered = [hs.signals.Signal2D(signal.data[m.data, :, :]) for m in masks]
        for f in filtered:
            f.set_signal_type("electron_diffraction")
            _copy_axes_object_metadata(
                signal.axes_manager.signal_axes[0], f.axes_manager.signal_axes[0]
            )
            _copy_axes_object_metadata(
                signal.axes_manager.signal_axes[1], f.axes_manager.signal_axes[1]
            )
            f.metadata.add_dictionary(signal.metadata.as_dictionary())
        return filtered, thickness


    bins = np.linspace(
        np.min(thickness, axis=(0, 1)), np.max(thickness, axis=(0, 1)), num=2 + 1
    )
    filtered, thickness = thickness_filter(s, thickness, bins)
    var = [
        f.get_variance(npt=50, gain=4.2, radial_range=(3.0, 5.7), mask=mask)
        for f in filtered
    ]

    # Note that the y-axis is the variance here. Hyperspy just always labels this as "Intensity"
    for v in var:
        v.axes_manager[0].units = "$nm^{-1}$"
    hs.plot.plot_spectra(var, legend=["thickness<17.5nm", "thickness<18.5nm"])



.. image-sg:: /examples/amorphous_characterization/images/sphx_glr_FEM_007.png
   :alt: FEM
   :srcset: /examples/amorphous_characterization/images/sphx_glr_FEM_007.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/49 [00:00<?, ?it/s]    100%|██████████| 49/49 [00:00<00:00, 782.02it/s]
      0%|          | 0/49 [00:00<?, ?it/s]    100%|██████████| 49/49 [00:00<00:00, 1296.65it/s]
      0%|          | 0/51 [00:00<?, ?it/s]    100%|██████████| 51/51 [00:00<00:00, 810.88it/s]
      0%|          | 0/51 [00:00<?, ?it/s]    100%|██████████| 51/51 [00:00<00:00, 1315.26it/s]

    <Axes: xlabel='Radius ($nm^{-1}$)', ylabel='Intensity'>




.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 52.917 seconds)


.. _sphx_glr_download_examples_amorphous_characterization_FEM.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: FEM.ipynb <FEM.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: FEM.py <FEM.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: FEM.zip <FEM.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
