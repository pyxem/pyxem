
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples/processing/determining_ellipticity.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_processing_determining_ellipticity.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_processing_determining_ellipticity.py:


Determining Elliptic Distortion
===============================
This example shows how to determine the elliptic distortion of an diffraction pattern from uncorrected
2-fold astigmatism.  Determining the exact elliptic distortion is important for tasks such as

- Orientation mapping
- Angular Correlation (AC)
- Fluctuation Electron Microscopy (FEM)
- And many other 4-D STEM techniques

Note that this workflow might change (simplify and improve!) in the future as pyxem
1.0.0 is developed/released.

.. GENERATED FROM PYTHON SOURCE LINES 17-18

First, we import the necessary packages and make a single test diffraction pattern.

.. GENERATED FROM PYTHON SOURCE LINES 18-35

.. code-block:: Python

    import pyxem.data.dummy_data.make_diffraction_test_data as mdtd
    import pyxem as pxm
    import pyxem.utils.ransac_ellipse_tools as ret
    import hyperspy.api as hs
    from skimage import morphology
    from scipy.signal import convolve2d
    from pyxem.signals.diffraction2d import Diffraction2D
    import math
    import numpy as np

    test_data = mdtd.MakeTestData(200, 200, default=False)
    test_data.add_disk(x0=100, y0=100, r=5, intensity=30)
    test_data.add_ring_ellipse(x0=100, y0=100, semi_len0=63, semi_len1=70, rotation=45)
    s = test_data.signal
    s.set_signal_type("electron_diffraction")
    s.plot()




.. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_001.png
   :alt:  Signal
   :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/hyperspy/misc/utils.py:72: VisibleDeprecationWarning: `_get_block_pattern` has moved to `hyperspy.misc.dask_utils`. It is for internal use only and may be removed in the future.
      warnings.warn(




.. GENERATED FROM PYTHON SOURCE LINES 36-42

Using RANSAC Ellipse Determination
----------------------------------
The RANSAC algorithm is a robust method for fitting an ellipse to points with outliers. Here we
use it to determine the elliptic distortion of the diffraction pattern and exclude the zero
beam as "outliers".  We can also manually exclude other points from the fit by using the
mask parameter.

.. GENERATED FROM PYTHON SOURCE LINES 42-57

.. code-block:: Python



    center, affine, params, pos, inlier = pxm.utils.ransac_ellipse_tools.determine_ellipse(
        s, use_ransac=True, return_params=True
    )

    el, in_points, out_points = pxm.utils.ransac_ellipse_tools.ellipse_to_markers(
        ellipse_array=params, points=pos, inlier=inlier
    )

    s.plot()
    s.add_marker(in_points, plot_marker=True)
    s.add_marker(el, plot_marker=True)
    s.add_marker(out_points, plot_marker=True)




.. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_002.png
   :alt:  Signal
   :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_002.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:681: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      affine = _ellipse_to_affine(el.params[3], el.params[2], el.params[4])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:682: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      center = (el.params[0], el.params[1])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:684: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      return center, affine, el.params, pos, inlier




.. GENERATED FROM PYTHON SOURCE LINES 58-62

Using Manual Ellipse Determination
----------------------------------
Sometimes it is useful to force the ellipse to fit certain points.  For example, here we
can force the ellipse to fit the first ring by masking the zero beam.

.. GENERATED FROM PYTHON SOURCE LINES 62-82

.. code-block:: Python



    mask = s.get_direct_beam_mask(radius=20)

    center, affine, params, pos = pxm.utils.ransac_ellipse_tools.determine_ellipse(
        s,
        return_params=True,
        mask=mask.data,
        num_points=500,
        use_ransac=False,
    )
    el, in_points = pxm.utils.ransac_ellipse_tools.ellipse_to_markers(
        ellipse_array=params,
        points=pos,
    )

    s.plot()
    s.add_marker(in_points, plot_marker=True)
    s.add_marker(el, plot_marker=True)




.. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_003.png
   :alt:  Signal
   :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_003.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:677: FutureWarning: Calling ``EllipseModel()`` (without arguments) has been deprecated since version 0.26 and will be removed in version 2.2; see help for ``EllipseModel``.
      e = EllipseModel()
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:678: FutureWarning: `estimate` is deprecated since version 0.26 and will be removed in version 2.2. Please use `EllipseModel.from_estimate` class constructor instead.
      converge = e.estimate(data=pos)
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:681: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      affine = _ellipse_to_affine(el.params[3], el.params[2], el.params[4])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:682: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      center = (el.params[0], el.params[1])
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:686: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      return center, affine, el.params, pos




.. GENERATED FROM PYTHON SOURCE LINES 83-96

.. code-block:: Python


    s.unit = "k_nm^-1"
    s.beam_energy = 200
    s.calibration.affine = affine
    az = s.get_azimuthal_integral2d(npt=100, inplace=False)
    corr = s.apply_affine_transformation(affine, inplace=False)

    hs.plot.plot_images(
        [az, corr],
        label=["azimuthal unwrapped", "corrected"],
        tight_layout=True,
        colorbar=None,
    )



.. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_004.png
   :alt: azimuthal unwrapped, corrected
   :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_004.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/2 [00:00<?, ?it/s]     50%|█████     | 1/2 [00:03<00:03,  3.04s/it]    100%|██████████| 2/2 [00:03<00:00,  1.52s/it]
      0%|          | 0/2 [00:00<?, ?it/s]    100%|██████████| 2/2 [00:00<00:00, 1737.13it/s]

    [<Axes: title={'center': 'azimuthal unwrapped'}, xlabel='Radians axis (Rad)', ylabel='Radius axis (k_nm^-1)'>, <Axes: title={'center': 'corrected'}, xlabel='kx axis (k_nm^-1)', ylabel='ky axis (k_nm^-1)'>]



.. GENERATED FROM PYTHON SOURCE LINES 97-102

Ellipse from Points
-------------------
This workflow will likely change slightly in the future to add better parllelism,
but here is how to determine the ellipticity from a set of points.
making a test elliptical diffraction pattern

.. GENERATED FROM PYTHON SOURCE LINES 102-114

.. code-block:: Python


    xf, yf, a, b, r, nt = 100, 115, 45, 35, 0, 15
    data_points = ret.make_ellipse_data_points(xf, yf, a, b, r, nt)
    image = np.zeros(shape=(200, 210), dtype=np.float32)
    for x, y in data_points:
        image[int(round(x)), int(round(y))] = 100
    disk = morphology.disk(5, np.uint16)
    image = convolve2d(image, disk, mode="same")
    data = np.zeros((2, 3, 210, 200), dtype=np.float32)
    data[:, :] = image.T
    s = Diffraction2D(data)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:209: FutureWarning: Calling ``EllipseModel()`` (without arguments) has been deprecated since version 0.26 and will be removed in version 2.2; see help for ``EllipseModel``.
      data = EllipseModel().predict_xy(theta_array, params=params)
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:209: FutureWarning: Parameter `params` is deprecated since version 0.26 and will be removed in 2.2 (or later). To avoid this warning, please do not use the parameter `params`. For more details, see the documentation of `EllipseModel.predict_xy`.
      data = EllipseModel().predict_xy(theta_array, params=params)




.. GENERATED FROM PYTHON SOURCE LINES 115-116

Finding the peaks

.. GENERATED FROM PYTHON SOURCE LINES 116-147

.. code-block:: Python


    s_t = s.template_match_disk(disk_r=5)
    peak_array = s_t.find_peaks(
        method="difference_of_gaussian",
        threshold=0.1,
        lazy_output=False,
        interactive=False,
    ).data

    c = math.sqrt(math.pow(a, 2) - math.pow(b, 2))
    xc, yc = xf - c * math.cos(r), yf - c * math.sin(r)

    ellipse_array, inlier_array = ret.get_ellipse_model_ransac(
        peak_array,
        yf=yf,  # center y
        xf=xf,  # center x
        rf_lim=15,  # max center error
        semi_len_min=min(a, b) - 5,  # min semi-len
        semi_len_max=max(a, b) + 5,  # max semi-len
        semi_len_ratio_lim=2,  # max semi-len ratio
        max_trials=50,
        min_samples=10,  # min inliers to fit
    )

    s.add_ellipse_array_as_markers(ellipse_array)
    el = ellipse_array[0, 0]
    affine = ret._ellipse_to_affine(el[2], el[3], el[4])

    tr = s.apply_affine_transformation(affine, inplace=False)
    tr.plot()




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_005.png
         :alt: determining ellipticity
         :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_006.png
         :alt:  Signal
         :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_006.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_007.png
         :alt: determining ellipticity
         :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_007.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /examples/processing/images/sphx_glr_determining_ellipticity_008.png
         :alt:  Signal
         :srcset: /examples/processing/images/sphx_glr_determining_ellipticity_008.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/2 [00:00<?, ?it/s]    100%|██████████| 2/2 [00:00<00:00, 149.82it/s]
      0%|          | 0/2 [00:00<?, ?it/s]     50%|█████     | 1/2 [00:00<00:00,  2.95it/s]    100%|██████████| 2/2 [00:00<00:00,  5.89it/s]
      0%|          | 0/6 [00:00<?, ?it/s]/opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:82: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      xc, yc, a, b, r = ellipse_model.params
    /opt/hostedtoolcache/Python/3.12.12/x64/lib/python3.12/site-packages/pyxem/utils/ransac_ellipse_tools.py:441: FutureWarning: `params` is deprecated since version 0.26 and will be removed in version 2.2. `params` attribute deprecated; use `center, axis_lengths, theta` attributes instead.
      params = ellipse_model.params
    100%|██████████| 6/6 [00:00<00:00, 402.20it/s]
      0%|          | 0/2 [00:00<?, ?it/s]    100%|██████████| 2/2 [00:00<00:00, 434.51it/s]





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 16.862 seconds)


.. _sphx_glr_download_examples_processing_determining_ellipticity.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: determining_ellipticity.ipynb <determining_ellipticity.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: determining_ellipticity.py <determining_ellipticity.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: determining_ellipticity.zip <determining_ellipticity.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
